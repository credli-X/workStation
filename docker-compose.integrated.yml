version: '3.8'

services:
  workstation:
    build:
      context: .
      dockerfile: Dockerfile.integrated
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD)}
        VERSION: ${VERSION:-1.0.0}
    image: workstation:latest
    container_name: workstation
    ports:
      - "3000:3000"    # JWT Auth API
      - "8080:8080"    # Agent Server HTTP API
      - "8082:8082"    # Agent Server WebSocket
    environment:
      # Main Application
      - NODE_ENV=production
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-24h}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # Agent Server
      - AGENT_SERVER_WS_PORT=8082
      - AGENT_SERVER_HTTP_PORT=8080
      - AGENT_SERVER_HOST=0.0.0.0
      
      # Chrome DevTools Protocol (CDP)
      - CDP_HOST=host.docker.internal
      - CDP_PORT=9222
      
      # CORS Configuration
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    volumes:
      # Optional: Mount data directory for persistence
      - workstation-data:/app/data
      # Optional: Mount logs directory
      - workstation-logs:/app/logs
    networks:
      - workstation-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Chrome browser with remote debugging for MCP
  # Uncomment to run Chrome in Docker for testing
  # chrome:
  #   image: browserless/chrome:latest
  #   container_name: workstation-chrome
  #   ports:
  #     - "9222:9222"  # Chrome DevTools Protocol
  #   environment:
  #     - CONNECTION_TIMEOUT=60000
  #     - MAX_CONCURRENT_SESSIONS=10
  #     - ENABLE_DEBUGGER=true
  #   networks:
  #     - workstation-network
  #   restart: unless-stopped

networks:
  workstation-network:
    driver: bridge

volumes:
  workstation-data:
    driver: local
  workstation-logs:
    driver: local
