name: Create GitHub Labels

# This workflow creates the required labels for Dependabot configuration
# It can be run manually via workflow_dispatch or automatically on push to main

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (list labels without creating)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  # Automatically run when dependabot.yml is modified
  push:
    paths:
      - '.github/dependabot.yml'
    branches:
      - main

permissions:
  issues: write  # Required to create labels
  contents: read

jobs:
  create-labels:
    runs-on: ubuntu-latest
    name: Create Required Labels
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List existing labels (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìã Current labels in repository:"
          gh label list --repo ${{ github.repository }} --limit 1000
          echo ""
          echo "üîç Checking for required labels..."
          
          MISSING=()
          for label in "dependencies" "github-actions" "production" "automated"; do
            if ! gh label list --repo ${{ github.repository }} --limit 1000 | grep -q "^$label"; then
              MISSING+=("$label")
            fi
          done
          
          if [ ${#MISSING[@]} -eq 0 ]; then
            echo "‚úÖ All required labels exist"
          else
            echo "‚ùå Missing labels: ${MISSING[*]}"
            echo "Run this workflow without dry_run to create them"
          fi

      - name: Create dependencies label
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh label list --repo ${{ github.repository }} --limit 1000 | grep -q "^dependencies"; then
            echo "‚ÑπÔ∏è  Label 'dependencies' already exists"
          else
            gh label create "dependencies" \
              --repo ${{ github.repository }} \
              --color "0366d6" \
              --description "Pull requests that update a dependency file" \
              && echo "‚úÖ Created label: dependencies" \
              || echo "‚ö†Ô∏è  Failed to create label: dependencies"
          fi

      - name: Create github-actions label
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh label list --repo ${{ github.repository }} --limit 1000 | grep -q "^github-actions"; then
            echo "‚ÑπÔ∏è  Label 'github-actions' already exists"
          else
            gh label create "github-actions" \
              --repo ${{ github.repository }} \
              --color "000000" \
              --description "Pull requests that update GitHub Actions code" \
              && echo "‚úÖ Created label: github-actions" \
              || echo "‚ö†Ô∏è  Failed to create label: github-actions"
          fi

      - name: Create production label
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh label list --repo ${{ github.repository }} --limit 1000 | grep -q "^production"; then
            echo "‚ÑπÔ∏è  Label 'production' already exists"
          else
            gh label create "production" \
              --repo ${{ github.repository }} \
              --color "d73a4a" \
              --description "Production dependencies" \
              && echo "‚úÖ Created label: production" \
              || echo "‚ö†Ô∏è  Failed to create label: production"
          fi

      - name: Create automated label
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh label list --repo ${{ github.repository }} --limit 1000 | grep -q "^automated"; then
            echo "‚ÑπÔ∏è  Label 'automated' already exists"
          else
            gh label create "automated" \
              --repo ${{ github.repository }} \
              --color "ededed" \
              --description "Automated updates" \
              && echo "‚úÖ Created label: automated" \
              || echo "‚ö†Ô∏è  Failed to create label: automated"
          fi

      - name: Summary
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìä Final label status:"
          echo ""
          gh label list --repo ${{ github.repository }} --limit 1000 | grep -E "dependencies|github-actions|production|automated" || true
          echo ""
          echo "‚úÖ Label creation workflow complete!"
          echo "View all labels: https://github.com/${{ github.repository }}/labels"
